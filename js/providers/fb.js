const FBProvider=class extends AbstractProvider{constructor(){super(),this.async_get_token=$('script:contains("async_get_token")').text().split('async_get_token":"').pop().split('"')[0],this.user_id=$('script:contains("async_get_token")').text().split('USER_ID":"').pop().split('"')[0],this.INIT_CLASS="mb-pnnclahpifbjkboanbjecjoaoelleoep",this.IN_PROGESS_CLASS="pr-pnnclahpifbjkboanbjecjoaoelleoep"}GetVideoIdFromURL(t){if(!t)return null;let i=null;try{var r;let n,o=new URL(t),s=o.search.replace(/^\?/,""),l=o.pathname,a=(r=s,n={},r.split("&").forEach(function(t){(t=t.split("="))[0]&&t[1]&&(n[t[0]]=decodeURIComponent(t[1]))}),n);if(l.includes("ajax/sharer")?i=a.id:l.includes("/videos/")?!(i=(i=l.match(/\/videos\/(\d+)/))&&i[1])&&/\/videos\/pcb\.\d+\/\d+/.test(l)&&(i=l.match(/\/videos\/pcb\.\d+\/(\d+)/)[1]):l.includes("/watch/")||l.includes("/watch?v=")||l.match(/\/watch$/)?i=a.v:l.includes("permalink.php")?i=a.story_fbid:l.includes("/reel/")&&(i=(i=l.match(/\/reel\/(\d+)/))&&i[1]),!i)return null;i=parseInt(i)}catch(c){return null}return i}GetPageType(){return window.location.href.includes("/stories/")?"STORIES":window.location.href.includes("/reel/")?"REELS":window.location.href.includes("watch/live")?"WATCH_LIVE":window.location.href.includes("watch/shows")?"WATCH_SHOWS":window.location.href.includes("watch/saved")?"WATCH_SAVED":/watch\/[\w.-_]+\//.test(window.location.href)?"WATCH_OF_USER_PAGE":/watch[\/]?\?v=/.test(window.location.href)?"WATCH_WITH_MAIN_VIDEO":/watch[\/?]/.test(window.location.href)||/watch$/.test(window.location.href)?"WATCH":/facebook\.com\/[\w.-_]+\/videos\/\d+\/?/.test(window.location.href)||/facebook\.com\/[\w.-_]+\/videos\/pcb\.[\w.-_]+\/\d+\/?/.test(window.location.href)?"VIDEOS":/facebook\.com\/[\w.-_]+\/videos\/?/.test(window.location.href)?"VIDEOS_OF_USER_PAGE":document.querySelector('[role="main"] [role="article"]')||document.querySelector('[role="feed"] [role="article"]')||document.querySelectorAll('[role="article"]').length>1?"POSTS_FEED":"UNKNOWN"}async searchVideoOld(t,i,r){try{await this.GetVideosFromURL(t,i,r)}catch(n){await this.getVideoFromPost(t,i,r)}}async searchVideo(t,i,r){if(this.async_get_token&&this.user_id)try{await this.getVideoFromVideoData(t,i,r)}catch(n){await this.searchVideoOld(t,i,r)}else await this.searchVideoOld(t,i,r)}async search(){let t=document.querySelectorAll(`.${this.INIT_CLASS}`);if(window.location.href!==this.location){for(let i of(this.videos=[],this.setBadge(),t))i.classList.remove(this.INIT_CLASS),i.classList.remove(this.IN_PROGESS_CLASS);this.location=window.location.href}let r=this.videos.map(t=>""+t.vid),n=Array.from(t).filter(t=>t.dataset.vdUid).map(t=>""+t.dataset.vdUid),o=r.filter(t=>!n.includes(t)).concat(n.filter(t=>!r.includes(t)));o.length&&(o.forEach(t=>{this.ids.hasOwnProperty(t)&&delete this.ids[t]}),this.videos=this.videos.filter(t=>!o.includes(t.vid)),t.forEach(t=>{o.includes(t.dataset.vdUid)&&(t.classList.remove(this.INIT_CLASS),t.classList.remove(this.IN_PROGESS_CLASS),delete t.dataset.vdUid)}),this.setBadge());let s=!1,l=!1,a=document.querySelectorAll(`video:not(.${this.INIT_CLASS}):not(.${this.IN_PROGESS_CLASS})`);for(let c of a){if(c.classList.contains(this.INIT_CLASS)||c.classList.contains(this.IN_PROGESS_CLASS))continue;l=!0,c.classList.add(this.IN_PROGESS_CLASS);let h=this.GetVideoId(c);if(h&&(s=!0),h){let d=this.GetTitleForVideo(c);d||(d="Facebook video - "+h),await this.searchVideo(h,d,c)}c.classList.add(this.INIT_CLASS)}if(!s&&l){let u=this.GetVideoIdFromURL(this.location);u&&await this.searchVideo(u,"Facebook video - "+u,"single_from_url")}}GetVideoId(t){let i=this.GetVideoIdFromClosest(t);return i||(i=this.GetVideoIfFromParent(t)),i}GetVideoIdFromClosest(t){let i=t.closest('a[href*="/videos/"]');if(i){let r=i.getAttribute("href");if(r&&r.length&&!/^https:/.test(r))return this.GetVideoIdFromURL(`https://www.facebook.com${r}`)}return!1}GetParentWithSameWidth(t){let i=t.clientWidth,r=t.parentElement;return i!==r.clientWidth?t:this.GetParentWithSameWidth(r)}GetParentContainsSelector(t,i){return t?t.querySelector(i)?t:this.GetParentContainsSelector(t.parentElement,i):null}GetParentElement(t){let i=this.GetPageType(),r=t===document.querySelector("video"),n;if("POSTS_FEED"===i){if(n=t.closest('[role="article"]'))return n}else if(["WATCH_WITH_MAIN_VIDEO","WATCH"].includes(i)){if((n=t.closest("._6x84"))||"WATCH_WITH_MAIN_VIDEO"==i&&r&&(n=this.GetParentWithSameWidth(t)))return n}else if("WATCH_OF_USER_PAGE"===i&&r){if(n=this.GetParentWithSameWidth(t))return n}else if("VIDEOS"===i){if(n=t.closest('[role="dialog"]'))return n}else if("STORIES"==i)return t.closest("[data-id]");else if("REELS"===i)return t.closest("[data-video-id");return(n=this.GetParentContainsSelector(t,'a[href*="/videos/"]'))||(n=this.GetParentContainsSelector(t,'a[href*="/watch?v="]')),n||(n=this.GetParentContainsSelector(t,'a[href*="/watch/?v="]')),n||(n=this.GetParentContainsSelector(t,'img[src*="//scontent"]')),n}GetVideoIfFromParent(t){let i=this.GetParentElement(t);if(!i)return null;let r=this.GetPageType();if("REELS"===r)return i.getAttribute("data-video-id");if("STORIES"===r)return null;if(["VIDEOS","WATCH_WITH_MAIN_VIDEO"].includes(r)&&i.querySelector("video")==document.querySelector("video"))return this.GetVideoIdFromURL(location.href);let n=i.querySelector('a[href*="/watch/?v="], a[href*="/watch?v="], a[href*="/videos/"], a[href*="/reel/"]');if(n){let o=n.getAttribute("href");if(o&&!/^https:/.test(o))return this.GetVideoIdFromURL(`https://www.facebook.com${o}`)}}deepSearchObject(t,i){if(t.hasOwnProperty(i))return t[i];for(let r in t)if(t.hasOwnProperty(r)&&t[r]&&"object"==typeof t[r]){let n=this.deepSearchObject(t[r],i);if(n)return n}return null}GetTitleForVideo(t){function i(t){if(!t)return null;if(1===t.children.length)return i(t.children[0]);let r,n;for(let o of t.children)!o.querySelector("video")&&o.innerText&&o.innerText.length>0&&(o.querySelector('a[href*="watch"]')||o.querySelector('a[href*="videos"]'))?n=o:o.querySelector("video")&&(r=o);return n||i(r)}function r(t){if(!t)return null;let i=0,r=null;return t.querySelectorAll("span, div").forEach(function(t){if(t.children.length&&t.querySelector("image")||!t.innerText)return!1;let n=getComputedStyle(t).fontSize||t.style.fontSize;(n=n&&parseInt(n))>i&&(i=n,r=t.innerText)}),r}function n(t){for(let i of t.childNodes){if(3===i.nodeType)return i.textContent;if(1===i.nodeType&&i.clientHeight&&i.clientWidth&&i.innerText.length)return n(i)}return null}let o=this.GetParentElement(t);if(!o)return null;let s=this.GetPageType(),l=t===document.querySelector("video"),a=null;if("WATCH_WITH_MAIN_VIDEO"===s&&l)a=r(o);else if("WATCH_OF_USER_PAGE"===s&&l)a=r(i(o));else if(["WATCH_WITH_MAIN_VIDEO","WATCH"].includes(s))a=r(function t(i){return i?[].find.call(i.children,function(t){return t.innerText&&t.innerText.length>0&&!t.querySelector("a[href]")})||((i=[].find.call(i.children,function(t){return t.innerText&&t.innerText.length>0}))?t(i):null):null}(i(o)));else if("VIDEOS"===s){var c;let h,d;(a=r((h=null,(d=(c=o).querySelector('[role="complementary"]'))&&(h=function t(i){return i?[].find.call(i.children,function(t){return t.querySelector("h2")&&!t.querySelector("form")})||((i=[].find.call(i.children,function(t){return t.querySelector("h2")}))?t(i):null):null}(d)),h)))||(a=function(t){let i=t.querySelector('[dir="auto"]');for(let r of i)if(r&&r.clientWidth&&r.clientHeight&&r.innerText.replace(/[\.\d\s\t\r\n:,]/g,"").length>1)return n(r)||r.innerText}(t))}else"POSTS_FEED"==s&&(function t(i){if("article"!==i.getAttribute("role"))return!1;let r=i.querySelector('a[href*="reel"]');if(!r)return!1;let n=r.closest("ul");return!n||!n.closest('[role="article"]')}(o)?(a=o.innerText.match(/[^\n]+/))&&a.length&&(a=a[0]):!(a=function t(i){for(let r of i.children){if(r.querySelector("video"))return t(r);let o=r.querySelector('blockquote [dir="auto"], [data-ad-preview] [dir="auto"]');if(o&&o.clientWidth&&o.clientHeight&&o.innerText.replace(/[\.\d\s\t\r\n:,]/g,"").length>1)return n(o)||o.innerText}return null}(o))&&(a=function(t){let i=t.querySelectorAll('blockquote [dir="auto"], [data-ad-preview] [dir="auto"]');for(let r of i)if(r&&r.clientWidth&&r.clientHeight&&r.innerText.replace(/[\.\d\s\t\r\n:,]/g,"").length>1)return n(r)||r.innerText}(o))&&(a=a.match(/[^\n]+/))&&a.length&&(a=a[0]));return a&&(a=(a=a.trim().replace(/[\n\t\r].*/,"")).replace(/[:,\-;]$/,"").trim()).length>110&&(a=a.substr(0,100)+"..."),a}async getVideoFromVideoData(t,i,r){if(!t)throw"no video id";let n=`https://www.facebook.com/video/video_data_async/?video_id=${t}&fb_dtsg_ag=${this.async_get_token}&__user=${this.user_id}&__a=1`,o=await this.Fetch(n,!1),s=JSON.parse(o.replace(/^([^{])+/,"")),l=this.deepSearchObject(s,"sd_src_no_ratelimit");l||(l=this.deepSearchObject(s,"sd_src"));let a=this.deepSearchObject(s,"hd_src_no_ratelimit");if(a||(a=this.deepSearchObject(s,"hd_src")),!l&&!a)throw Error("Not found videos - ");let c={vid:t,variants:[],title:i};r&&(r.dataset.vdUid=t),l&&c.variants.push({url:l,quality:"240"}),a&&c.variants.push({url:a,quality:"720"}),this.pushVideo(c)}async getVideoFromPost(t,i,r){let n=await this.Fetch(`https://m.facebook.com/story.php?story_fbid=${t}&id=${this.user_id}`,!1),o=this.findOnceMatch(n,/video&quot;,&quot;src&quot;:\s*&quot;([^\"]+)&quot;/);if(o){let s=o[0].replaceAll("\\","").replaceAll("&amp;","&").split("&quot;")[0];$("<div />",{html:n.split("<strong>")[1].split("</strong>")[0]+" - "+e.split("<abbr>")[1].split("</abbr>")[0]}).text(),this.pushVideo({vid:t,variants:[{url:s,quality:"240"}],title:i})}}async GetVideosFromURL(t,i,r){if(!t)throw"no video id";let n=`https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(`https://www.facebook.com/watch/?v=${t}`)}`,o=await this.Fetch(n,!1),s=$("<output>").append(o),l=this.findMatch(o,/\"video_id\":\s*\"([^\"]+)\"/gi,"video_id");l||(l=[t]);let a=this.findMatch(o,/\"sd_src_no_ratelimit\":\s*\"([^\"]+)\"/gi,"sd_src_no_ratelimit");a.length||(a=this.findOnceMatch(o,/sd_src_no_ratelimit:\s*\"([^\"]+)\"/)),!a.length&&(a=$('meta[property="og:video:url"]',s).attr("content"))&&(a=[a]),a.length||(a=this.findMatch(o,/\"sd_src\":\s*\"([^\"]+)\"/gi,"sd_src"));let c=this.findMatch(o,/\"hd_src_no_ratelimit\":\s*\"([^\"]+)\"/gi,"hd_src_no_ratelimit");if(c.length||(c=this.findOnceMatch(o,/hd_src_no_ratelimit:\s*\"([^\"]+)\"/)),c.length||(c=this.findMatch(o,/\"hd_src\":\s*\"([^\"]+)\"/gi,"hd_src")),!l||!a||l.length<a.length)throw Error("Not found all ids");if(!a.length&&!c.length)throw Error("Not found videos - ");let h={vid:t,variants:[],title:i||s.find("#u_0_c").text()||"Facebook video -"+t};r&&(r.dataset.vdUid=t),a.length&&a[0]&&h.variants.push({url:a[0],quality:"240"}),c.length&&c[0]&&h.variants.push({url:c[0],quality:"720"}),this.pushVideo(h)}findOnceMatch(t,i){var r=t.match(i);return r?[r[1]]:[]}findMatch(t,i,r){var n=t.match(i);return n?n.filter(function(t,i,r){return r.indexOf(t)===i&&t}).map(t=>JSON.parse("{"+t+"}")[r]):[]}pushVideo(t){!this.ids.hasOwnProperty(t.vid)&&(this.ids[t.vid]=!0,this.videos=this.videos.concat(t),t.variants.length>0&&(this.updateVideos(t),this.setBadge()))}updateVideos(t){for(let i=0;i<this.videos.length;i++)if(this.videos[i].vid==t.vid){this.videos[i]={...t};break}}hashCode(){return Math.random().toString(36).substring(2)+(new Date).getTime().toString(36)}async Fetch(t,i){let r=await chrome.runtime.sendMessage({action:"makeXHRrequest",url:t,config:{},responseType:i?"json":"text"});return chrome.runtime.lastError&&console.log(`error = ${chrome.runtime.lastError}`),r}};