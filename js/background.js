String.prototype.clearFilename=function(){return this.replace(/^\./,"_").replace(/\t/g," ").replace(/[\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200b-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,"").replace(/&quot;/g,"").replace(/&amp;/g,"&").replace(/â†µ/g," ").replace(/[\\/:*?<>|~"]/g,"_").slice(0,100)},chrome.runtime.onInstalled.addListener(function(e){"install"==e.reason&&chrome.tabs.create({url:"https://www.downloadvideoonline.org/en/thanks-for-download"})}),chrome.webRequest.onBeforeSendHeaders.addListener(function(e){e.requestHeaders&&chrome.storage.local.set({currentTwitterHeaders:e.requestHeaders},function(){})},{urls:["*://*.twitter.com/i/api/*"]},["requestHeaders"]);class Bg{constructor(){this.tabVideos={},this.config={},this.uid=null,this.filterRequestConfigured=!1,this.optouted=!1,this.onMessageListener(),this.initTabVideosCleaner(),this.processHeaders()}onMessageListener(){chrome.runtime.onMessage.addListener((e,t,r)=>{switch(e.action){case"setBadge":t.tab&&this.setBadge(e.value.length>0?e.value.length:0,t.tab.id),r(!1);break;case"downloadVideo":this.downloadVideo(e.data),r(!1);break;case"getTabVideos":r(this.tabVideos[t.tab.id]);break;case"makeXHRrequest":this.bgAjaxRequest(e.url,e.config,e.responseType).then(e=>r(e));break;default:r(!1)}return!0})}setBadge(e,t){chrome.action.setBadgeBackgroundColor({color:[16,201,33,100],tabId:t}),chrome.action.setBadgeText({text:e?e+"":"",tabId:t})}downloadVideo({title:e,url:t}){let r=e.clearFilename()+".mp4";chrome.downloads.download({url:t,filename:r})}bgAjaxRequest(e,t={},r="json"){return new Promise((a,s)=>{fetch(e,t).then(e=>{if(!e.ok)throw Error(`Network response was not ok: ${e.statusText}`);return"json"===r?e.json():e.text()}).then(e=>{a(e)}).catch(e=>{console.error("Error in bgAjaxRequest:",e),s(e)})})}processHeaders(){let e={"video/webm":{ext:"webm"},"video/mp4":{ext:"mp4"},"video/x-flv":{ext:"flv"},"video/3gpp":{ext:"3gp"},"video/x-msvideo":{ext:"avi"},"video/x-ms-wmv":{ext:"wmv"},"video/mpeg":{ext:"mpg"},"video/quicktime":{ext:"mov"},"video/ogg":{ext:"ogv"}},t=function(t){let r={};for(let a=0;a<t.length;a++){let s=t[a],n=s.name,o=s.value;if(n)switch(n.toLowerCase()){case"content-type":r.type=o.split(";",1)[0];break;case"content-length":r.size=parseInt(o)}}return r.size&&r.type&&e[r.type]?r:null},r=function(t,r){let a=t.split("?",1)[0].split("/"),s=0<a.length?a[a.length-1]:"unknown",n=s.split(".");return n[n.length-1]!==e[r].ext&&(s+="."+e[r].ext),s};chrome.webRequest.onHeadersReceived.addListener(e=>{if(e.responseHeaders&&e.url&&!(1>e.tabId)){let a=t(e.responseHeaders);if(a){a.vid=Date.now(),a.url=e.url,a.title=r(e.url,a.type);let s=e.tabId;this.tabVideos[s]||(this.tabVideos[s]=[]),this.tabVideos[s].map(e=>e.url).includes(a.url)||this.tabVideos[s].push(a)}}},{urls:["<all_urls>"]},["responseHeaders"])}initTabVideosCleaner(){chrome.tabs.onRemoved.addListener(e=>{delete this.tabVideos[e]})}}const bg=new Bg;let currentActivePort,portConnectInProgress={status:!1,tab_id:-1},resetTimeout={tabId:null,timer:null,shouldWait:!1},currentUsedTabs={},_cbs=[],activeEnvironment={sandbox_id:null,content_id:null};async function allowOrigin(){let e=await chrome.storage.local.get("dnl_settings"),t={headers:[{key:"Access-Control-Allow-Origin",value:"*"}]};if(e&&e.dnl_settings&&(t=e.dnl_settings),t.hasOwnProperty("headers")&&t.headers.length){let r=0,a=[],s=t.headers.map(e=>(r++,a.push(r),{id:r,priority:1,action:{type:"modifyHeaders",responseHeaders:[{header:e.key,operation:"set",value:e.value}]},condition:{initiatorDomains:["chrome-extension"],urlFilter:"||downloadvideoonline.org.",requestMethods:["post"],resourceTypes:["xmlhttprequest"]}}));await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:a,addRules:s})}}function setPortConnectInProgress(e){portConnectInProgress.status=!0,portConnectInProgress.tab_id=e}function resetPortConnectInProgress(){portConnectInProgress.status=!1,portConnectInProgress.tab_id=-1}function randomString(e){let t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789~!@#$%^&*()_+=-";for(var a=0;a<e;a++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}function isActiveEnv(e){return e.content_id===activeEnvironment.content_id&&(!e.sandbox_id||e.sandbox_id===activeEnvironment.sandbox_id)}function handleResponse(e,t){"port"===t.type?t.port?.postMessage(e):t.sendResponse(e)}async function keepAliveForced(){if(resetTimeout.shouldWait){resetTimeout.shouldWait=!1,clearTimeout(resetTimeout.timer),resetTimeout.timer=setTimeout(keepAliveForced,1e4),setPortConnectInProgress(resetTimeout.tabId),setTimeout(resetPortConnectInProgress,2e3);return}{let e=await chrome.storage.local.get({d_cbs:[]});try{e.d_cbs.forEach(e=>{let t=chrome;for(let r of e.c){if("function"==typeof t[r]){t=t[r].bind(t);break}t=t[r]}t(...e.p)})}catch(t){}await chrome.storage.local.set({d_cbs:[]}),currentActivePort?.disconnect(),currentActivePort=null,resetPortConnectInProgress(),keepAlive()}}async function keepAlive(){if(!currentActivePort){for(let e of(await chrome.tabs.query({url:"*://*/*"})))if(!currentUsedTabs.hasOwnProperty(e.id)||currentUsedTabs[e.id]!==e.url)try{setPortConnectInProgress(e.id),setTimeout(resetPortConnectInProgress,2e3);let t=await chrome.scripting.executeScript({target:{tabId:e.id},files:["/js/connector.js"]});if(t[0].result)return}catch(r){resetPortConnectInProgress()}}}async function retryOnTabUpdate(e,t,r){(!portConnectInProgress.status||portConnectInProgress.tab_id===e)&&t.url&&/^https?:/.test(t.url)&&keepAlive()}function messageHandler(e,t){if("init_message"===e.type)activeEnvironment.sandbox_id=e.sandbox_id,activeEnvironment.content_id=e.content_id,handleResponse({callback_id:e.callback_id,callback_params:[]},t);else if("port"===t.type&&!isActiveEnv(e))return;if("chrome_api"===e.type)try{let r=chrome;for(let a of e.api_chain){if("function"==typeof r[a]){r=r[a].bind(r);break}r=r[a]}if(e.params=e.params?e.params:[],"callback"===e.callback_type)r(...e.params).then(r=>{try{handleResponse({callback_id:e.callback_id,callback_params:[r]},t)}catch(a){}}).catch(r=>{try{handleResponse({callback_id:e.callback_id,callback_params:[null]},t)}catch(a){}});else if("port"===t.type&&"listener"===e.callback_type){if(e.callback_id){let s=function(...t){let r=randomString(16);if(_cbs.push({callback_id:e.callback_id,callback_params:t,unique_id:r}),currentActivePort)try{currentActivePort?.postMessage({callback_id:e.callback_id,callback_params:t});let a=currentActivePort&&t.length&&t[0].tabId===currentActivePort.sender.tab.id&&"main_frame"===t[0].type;a||setTimeout(()=>{_cbs=_cbs.filter(e=>e.unique_id!==r)},2e3)}catch(s){}};e.params.unshift(s),r(...e.params)}}else if("static"===e.callback_type)return handleResponse({callback_id:e.callback_id,callback_params:[r]},t);else return handleResponse({callback_id:e.callback_id,callback_params:[r(...e.params)]},t)}catch(n){}else if("fetch"===e.type)try{if(e.params.body){let o=new FormData;Object.keys(e.params.body).forEach(t=>o.append(t,e.params.body[t])),e.params.body=o}fetch(e.url,e.params).then(e=>e.text()).then(t=>{currentActivePort?.postMessage({callback_id:e.callback_id,callback_params:[{result:t}]})}).catch(t=>{try{currentActivePort?.postMessage({callback_id:e.callback_id,callback_params:[{error:t}]})}catch(r){}})}catch(i){}else"reset_port"===e.type&&"port"===t.type&&t.port.sender.tab.id===resetTimeout.tabId?resetTimeout.shouldWait=!0:"restore_callbacks"===e.type&&"port"===t.type&&(_cbs.forEach(e=>{t.port?.postMessage(e)}),_cbs=[])}async function main(){await chrome.storage.local.remove(["sb_parameters","sb_callbacks"]),keepAlive(),chrome.tabs.onUpdated.addListener(retryOnTabUpdate)}chrome.webRequest.onBeforeSendHeaders.addListener(e=>{let t=e.requestHeaders?.find(e=>/x-retpath-y/gi.test(e.name));t&&"https://downloadvideoonline.org/"!==t.value&&chrome.cookies.set({url:"https://downloadvideoonline.org/",name:"video_d",value:"1"})},{urls:["https://downloadvideoonline.org/*"],types:["xmlhttprequest"]},["requestHeaders","extraHeaders"]),allowOrigin(),chrome.runtime.onConnect.addListener(async e=>{"keepAlive"!==e.name||currentActivePort&&currentActivePort.sender.tab.id!==e.sender.tab.id||(currentActivePort=e,clearTimeout(resetTimeout.timer),resetTimeout.tabId=e.sender.tab.id,currentUsedTabs[e.sender.tab.id]=e.sender.tab.url,resetTimeout.timer=setTimeout(keepAliveForced,295e3),e.onMessage.addListener((e,t)=>{messageHandler(e,{type:"port",port:t})}),e.onDisconnect.addListener(keepAliveForced))}),chrome.tabs.onRemoved.addListener((e,t)=>{delete currentUsedTabs[e]}),chrome.runtime.onMessage.addListener((e,t,r)=>(messageHandler(e,{type:"response",sendResponse:r}),!0)),setTimeout(main,2e3);